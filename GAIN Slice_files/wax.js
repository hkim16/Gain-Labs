if(!com){var com={};com.modestmaps||(com.modestmaps={})}(function(a){a.extend=function(a,b){for(var c in b.prototype)typeof a.prototype[c]=="undefined"&&(a.prototype[c]=b.prototype[c]);return a},a.getFrame=function(){return function(a){(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(function(){a(+(new Date))},10)})(a)}}(),a.transformProperty=function(a){if(!!this.document){var b=document.documentElement.style;for(var c=0;c<a.length;c++)if(a[c]in b)return a[c];return!1}}(["transformProperty","WebkitTransform","OTransform","MozTransform","msTransform"]),a.matrixString=function(b){b.scale*b.width%1&&(b.scale+=(1-b.scale*b.width%1)/b.width);if(a._browser.webkit3d)return"matrix3d("+[b.scale||"1","0,0,0,0",b.scale||"1","0,0","0,0,1,0",(b.x+(b.width*b.scale-b.width)/2).toFixed(4),(b.y+(b.height*b.scale-b.height)/2).toFixed(4),0,1].join(",")+")";var c=a.transformProperty=="MozTransform"?"px":"";return"matrix("+[b.scale||"1",0,0,b.scale||"1",b.x+(b.width*b.scale-b.width)/2+c,b.y+(b.height*b.scale-b.height)/2+c].join(",")+")"},a._browser=function(a){return{webkit:"WebKitCSSMatrix"in a,webkit3d:"WebKitCSSMatrix"in a&&"m11"in new WebKitCSSMatrix}}(this),a.moveElement=function(b,c){if(a.transformProperty){var d=a.matrixString(c);b[a.transformProperty]!==d&&(b.style[a.transformProperty]=b[a.transformProperty]=d)}else b.style.left=c.x+"px",b.style.top=c.y+"px",b.style.width=Math.ceil(c.width*c.scale)+"px",b.style.height=Math.ceil(c.height*c.scale)+"px"},a.cancelEvent=function(a){a.cancelBubble=!0,a.cancel=!0,a.returnValue=!1,a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault();return!1},a.addEvent=function(a,b,c){a.attachEvent?(a["e"+b+c]=c,a[b+c]=function(){a["e"+b+c](window.event)},a.attachEvent("on"+b,a[b+c])):(a.addEventListener(b,c,!1),b=="mousewheel"&&a.addEventListener("DOMMouseScroll",c,!1))},a.bind=function(a,b){var c=Array.prototype.slice,d=Function.prototype.bind;if(a.bind===d&&d)return d.apply(a,c.call(arguments,1));var e=c.call(arguments,2);return function(){return a.apply(b,e.concat(c.call(arguments)))}},a.removeEvent=function(a,b,c){a.detachEvent?(a.detachEvent("on"+b,a[b+c]),a[b+c]=null):(a.removeEventListener(b,c,!1),b=="mousewheel"&&a.removeEventListener("DOMMouseScroll",c,!1))},a.getStyle=function(a,b){if(a.currentStyle)return a.currentStyle[b];if(window.getComputedStyle)return document.defaultView.getComputedStyle(a,null).getPropertyValue(b)},a.Point=function(a,b){this.x=parseFloat(a),this.y=parseFloat(b)},a.Point.prototype={x:0,y:0,toString:function(){return"("+this.x.toFixed(3)+", "+this.y.toFixed(3)+")"}},a.Point.distance=function(a,b){var c=b.x-a.x,d=b.y-a.y;return Math.sqrt(c*c+d*d)},a.Point.interpolate=function(b,c,d){var e=b.x+(c.x-b.x)*d,f=b.y+(c.y-b.y)*d;return new a.Point(e,f)},a.Coordinate=function(a,b,c){this.row=a,this.column=b,this.zoom=c},a.Coordinate.prototype={row:0,column:0,zoom:0,toString:function(){return"("+this.row.toFixed(3)+", "+this.column.toFixed(3)+" @"+this.zoom.toFixed(3)+")"},toKey:function(){return[this.zoom,this.row,this.column].join(",")},copy:function(){return new a.Coordinate(this.row,this.column,this.zoom)},container:function(){return new a.Coordinate(Math.floor(this.row),Math.floor(this.column),Math.floor(this.zoom))},zoomTo:function(b){var c=Math.pow(2,b-this.zoom);return new a.Coordinate(this.row*c,this.column*c,b)},zoomBy:function(b){var c=Math.pow(2,b);return new a.Coordinate(this.row*c,this.column*c,this.zoom+b)},up:function(b){b===undefined&&(b=1);return new a.Coordinate(this.row-b,this.column,this.zoom)},right:function(b){b===undefined&&(b=1);return new a.Coordinate(this.row,this.column+b,this.zoom)},down:function(b){b===undefined&&(b=1);return new a.Coordinate(this.row+b,this.column,this.zoom)},left:function(b){b===undefined&&(b=1);return new a.Coordinate(this.row,this.column-b,this.zoom)}},a.Location=function(a,b){this.lat=parseFloat(a),this.lon=parseFloat(b)},a.Location.prototype={lat:0,lon:0,toString:function(){return"("+this.lat.toFixed(3)+", "+this.lon.toFixed(3)+")"}},a.Location.distance=function(a,b,c){c||(c=6378e3);var d=Math.PI/180,e=a.lat*d,f=a.lon*d,g=b.lat*d,h=b.lon*d,i=Math.cos(e)*Math.cos(f)*Math.cos(g)*Math.cos(h),j=Math.cos(e)*Math.sin(f)*Math.cos(g)*Math.sin(h),k=Math.sin(e)*Math.sin(g);return Math.acos(i+j+k)*c},a.Location.interpolate=function(b,c,d){if(b.lat===c.lat&&b.lon===c.lon)return new a.Location(b.lat,b.lon);var e=Math.PI/180,f=b.lat*e,g=b.lon*e,h=c.lat*e,i=c.lon*e,j=2*Math.asin(Math.sqrt(Math.pow(Math.sin((f-h)/2),2)+Math.cos(f)*Math.cos(h)*Math.pow(Math.sin((g-i)/2),2))),k=Math.atan2(Math.sin(g-i)*Math.cos(h),Math.cos(f)*Math.sin(h)-Math.sin(f)*Math.cos(h)*Math.cos(g-i))/-(Math.PI/180);k=k<0?360+k:k;var l=Math.sin((1-d)*j)/Math.sin(j),m=Math.sin(d*j)/Math.sin(j),n=l*Math.cos(f)*Math.cos(g)+m*Math.cos(h)*Math.cos(i),o=l*Math.cos(f)*Math.sin(g)+m*Math.cos(h)*Math.sin(i),p=l*Math.sin(f)+m*Math.sin(h),q=Math.atan2(p,Math.sqrt(Math.pow(n,2)+Math.pow(o,2))),r=Math.atan2(o,n);return new a.Location(q/e,r/e)},a.Transformation=function(a,b,c,d,e,f){this.ax=a,this.bx=b,this.cx=c,this.ay=d,this.by=e,this.cy=f},a.Transformation.prototype={ax:0,bx:0,cx:0,ay:0,by:0,cy:0,transform:function(b){return new a.Point(this.ax*b.x+this.bx*b.y+this.cx,this.ay*b.x+this.by*b.y+this.cy)},untransform:function(b){return new a.Point((b.x*this.by-b.y*this.bx-this.cx*this.by+this.cy*this.bx)/(this.ax*this.by-this.ay*this.bx),(b.x*this.ay-b.y*this.ax-this.cx*this.ay+this.cy*this.ax)/(this.bx*this.ay-this.by*this.ax))}},a.deriveTransformation=function(b,c,d,e,f,g,h,i,j,k,l,m){var n=a.linearSolution(b,c,d,f,g,h,j,k,l),o=a.linearSolution(b,c,e,f,g,i,j,k,m);return new a.Transformation(n[0],n[1],n[2],o[0],o[1],o[2])},a.linearSolution=function(a,b,c,d,e,f,g,h,i){a=parseFloat(a),b=parseFloat(b),c=parseFloat(c),d=parseFloat(d),e=parseFloat(e),f=parseFloat(f),g=parseFloat(g),h=parseFloat(h),i=parseFloat(i);var j=((f-i)*(b-e)-(c-f)*(e-h))/((d-g)*(b-e)-(a-d)*(e-h)),k=((f-i)*(a-d)-(c-f)*(d-g))/((e-h)*(a-d)-(b-e)*(d-g)),l=c-a*j-b*k;return[j,k,l]},a.Projection=function(b,c){c||(c=new a.Transformation(1,0,0,0,1,0)),this.zoom=b,this.transformation=c},a.Projection.prototype={zoom:0,transformation:null,rawProject:function(a){throw"Abstract method not implemented by subclass."},rawUnproject:function(a){throw"Abstract method not implemented by subclass."},project:function(a){a=this.rawProject(a),this.transformation&&(a=this.transformation.transform(a));return a},unproject:function(a){this.transformation&&(a=this.transformation.untransform(a)),a=this.rawUnproject(a);return a},locationCoordinate:function(b){var c=new a.Point(Math.PI*b.lon/180,Math.PI*b.lat/180);c=this.project(c);return new a.Coordinate(c.y,c.x,this.zoom)},coordinateLocation:function(b){b=b.zoomTo(this.zoom);var c=new a.Point(b.column,b.row);c=this.unproject(c);return new a.Location(180*c.y/Math.PI,180*c.x/Math.PI)}},a.LinearProjection=function(b,c){a.Projection.call(this,b,c)},a.LinearProjection.prototype={rawProject:function(b){return new a.Point(b.x,b.y)},rawUnproject:function(b){return new a.Point(b.x,b.y)}},a.extend(a.LinearProjection,a.Projection),a.MercatorProjection=function(b,c){a.Projection.call(this,b,c)},a.MercatorProjection.prototype={rawProject:function(b){return new a.Point(b.x,Math.log(Math.tan(.25*Math.PI+.5*b.y)))},rawUnproject:function(b){return new a.Point(b.x,2*Math.atan(Math.pow(Math.E,b.y))-.5*Math.PI)}},a.extend(a.MercatorProjection,a.Projection),a.MapProvider=function(a){a&&(this.getTileUrl=a)},a.MapProvider.prototype={projection:new a.MercatorProjection(0,a.deriveTransformation(-Math.PI,Math.PI,0,0,Math.PI,Math.PI,1,0,-Math.PI,-Math.PI,0,1)),tileWidth:256,tileHeight:256,topLeftOuterLimit:new a.Coordinate(0,0,0),bottomRightInnerLimit:(new a.Coordinate(1,1,0)).zoomTo(18),getTileUrl:function(a){throw"Abstract method not implemented by subclass."},locationCoordinate:function(a){return this.projection.locationCoordinate(a)},coordinateLocation:function(a){return this.projection.coordinateLocation(a)},outerLimits:function(){return[this.topLeftOuterLimit.copy(),this.bottomRightInnerLimit.copy()]},setZoomRange:function(a,b){this.topLeftOuterLimit=this.topLeftOuterLimit.zoomTo(a),this.bottomRightInnerLimit=this.bottomRightInnerLimit.zoomTo(b)},sourceCoordinate:function(b){var c=this.topLeftOuterLimit.zoomTo(b.zoom),d=this.bottomRightInnerLimit.zoomTo(b.zoom),e=d.row-c.row;if(b.row<0|b.row>=e)return null;var f=d.column-c.column,g=b.column%f;while(g<0)g+=f;return new a.Coordinate(b.row,g,b.zoom)}},a.TemplatedMapProvider=function(b,c){a.MapProvider.call(this,function(a){a=this.sourceCoordinate(a);if(!a)return null;var d=b;if(c&&c.length&&d.indexOf("{S}")>=0){var e=parseInt(a.zoom+a.row+a.column,10)%c.length;d=d.replace("{S}",c[e])}return d.replace("{Z}",a.zoom.toFixed(0)).replace("{X}",a.column.toFixed(0)).replace("{Y}",a.row.toFixed(0))})},a.extend(a.TemplatedMapProvider,a.MapProvider),a.getMousePoint=function(b,c){var d=new a.Point(b.clientX,b.clientY);d.x+=document.body.scrollLeft+document.documentElement.scrollLeft,d.y+=document.body.scrollTop+document.documentElement.scrollTop;for(var e=c.parent;e;e=e.offsetParent)d.x-=e.offsetLeft,d.y-=e.offsetTop;return d},a.MouseWheelHandler=function(a){a!==undefined&&this.init(a)},a.MouseWheelHandler.prototype={init:function(b){this.map=b,a.addEvent(b.parent,"mousewheel",a.bind(this.mouseWheel,this))},mouseWheel:function(b){var c=0;this.prevTime=this.prevTime||(new Date).getTime(),b.wheelDelta?c=b.wheelDelta:b.detail&&(c=-b.detail);var d=(new Date).getTime()-this.prevTime;if(Math.abs(c)>0&&d>200){var e=a.getMousePoint(b,this.map);this.map.zoomByAbout(c>0?1:-1,e),this.prevTime=(new Date).getTime()}return a.cancelEvent(b)}},a.DoubleClickHandler=function(a){a!==undefined&&this.init(a)},a.DoubleClickHandler.prototype={init:function(b){this.map=b,a.addEvent(b.parent,"dblclick",this._doubleClick=a.bind(this.doubleClick,this))},doubleClick:function(b){var c=a.getMousePoint(b,this.map);this.map.zoomByAbout(b.shiftKey?-1:1,c);return a.cancelEvent(b)}},a.DragHandler=function(a){a!==undefined&&this.init(a)},a.DragHandler.prototype={init:function(b){this.map=b,a.addEvent(b.parent,"mousedown",a.bind(this.mouseDown,this))},mouseDown:function(b){a.addEvent(document,"mouseup",this._mouseUp=a.bind(this.mouseUp,this)),a.addEvent(document,"mousemove",this._mouseMove=a.bind(this.mouseMove,this)),this.prevMouse=new a.Point(b.clientX,b.clientY),this.map.parent.style.cursor="move";return a.cancelEvent(b)},mouseMove:function(b){this.prevMouse&&(this.map.panBy(b.clientX-this.prevMouse.x,b.clientY-this.prevMouse.y),this.prevMouse.x=b.clientX,this.prevMouse.y=b.clientY,this.prevMouse.t=+(new Date));return a.cancelEvent(b)},mouseUp:function(b){a.removeEvent(document,"mouseup",this._mouseUp),a.removeEvent(document,"mousemove",this._mouseMove),this.prevMouse=null,this.map.parent.style.cursor="";return a.cancelEvent(b)}},a.MouseHandler=function(a){a!==undefined&&this.init(a)},a.MouseHandler.prototype={init:function(b){this.map=b,new a.DragHandler(b),new a.DoubleClickHandler(b),new a.MouseWheelHandler(b)}},a.TouchHandler=function(){},a.TouchHandler.prototype={maxTapTime:250,maxTapDistance:30,maxDoubleTapDelay:350,locations:{},taps:[],wasPinching:!1,lastPinchCenter:null,init:function(b,c){this.map=b,c=c||{},a.addEvent(b.parent,"touchstart",a.bind(this.touchStartMachine,this)),a.addEvent(b.parent,"touchmove",a.bind(this.touchMoveMachine,this)),a.addEvent(b.parent,"touchend",a.bind(this.touchEndMachine,this)),this.options={},this.options.snapToZoom=c.snapToZoom||!0},updateTouches:function(a){for(var b=0;b<a.touches.length;b+=1){var c=a.touches[b];if(c.identifier in this.locations){var d=this.locations[c.identifier];d.x=c.screenX,d.y=c.screenY,d.scale=a.scale}else this.locations[c.identifier]={scale:a.scale,startPos:{x:c.screenX,y:c.screenY},x:c.screenX,y:c.screenY,time:(new Date).getTime()}}},sameTouch:function(a,b){return a&&a.touch&&b.identifier==a.touch.identifier},touchStartMachine:function(b){this.updateTouches(b);return a.cancelEvent(b)},touchMoveMachine:function(b){switch(b.touches.length){case 1:this.onPanning(b.touches[0]);break;case 2:this.onPinching(b)}this.updateTouches(b);return a.cancelEvent(b)},touchEndMachine:function(b){var c=(new Date).getTime();b.touches.length==0&&this.wasPinching&&this.onPinched(this.lastPinchCenter);for(var d=0;d<b.changedTouches.length;d+=1){var e=b.changedTouches[d],f=this.locations[e.identifier];if(!f||f.wasPinch)continue;var g={x:e.screenX,y:e.screenY},h=c-f.time,i=a.Point.distance(g,f.startPos);i>this.maxTapDistance||(h>this.maxTapTime?(g.end=c,g.duration=h,this.onHold(g)):(g.time=c,this.onTap(g)))}var j={};for(var k=0;k<b.touches.length;k++)j[b.touches[k].identifier]=!0;for(var l in this.locations)l in j||delete j[l];return a.cancelEvent(b)},onHold:function(a){},onTap:function(a){this.taps.length&&a.time-this.taps[0].time<this.maxDoubleTapDelay?(this.onDoubleTap(a),this.taps=[]):this.taps=[a]},onDoubleTap:function(b){var c=this.map.getZoom(),d=Math.round(c)+1,e=d-c,f=new a.Point(b.x,b.y);this.map.zoomByAbout(e,f)},onPanning:function(a){var b={x:a.screenX,y:a.screenY},c=this.locations[a.identifier];this.map.panBy(b.x-c.x,b.y-c.y)},onPinching:function(b){var c=b.touches[0],d=b.touches[1],e=new a.Point(c.screenX,c.screenY),f=new a.Point(d.screenX,d.screenY),g=this.locations[c.identifier],h=this.locations[d.identifier];g.wasPinch=!0,h.wasPinch=!0;var i=a.Point.interpolate(e,f,.5);this.map.zoomByAbout(Math.log(b.scale)/Math.LN2-Math.log(g.scale)/Math.LN2,i);var j=a.Point.interpolate(g,h,.5);this.map.panBy(i.x-j.x,i.y-j.y),this.wasPinching=!0,this.lastPinchCenter=i},onPinched:function(a){if(this.options.snapToZoom){var b=this.map.getZoom(),c=Math.round(b);this.map.zoomByAbout(c-b,a)}this.wasPinching=!1}},a.CallbackManager=function(a,b){this.owner=a,this.callbacks={};for(var c=0;c<b.length;c++)this.callbacks[b[c]]=[]},a.CallbackManager.prototype={owner:null,callbacks:null,addCallback:function(a,b){typeof b=="function"&&this.callbacks[a]&&this.callbacks[a].push(b)},removeCallback:function(a,b){if(typeof b=="function"&&this.callbacks[a]){var c=this.callbacks[a],d=c.length;for(var e=0;e<d;e++)if(c[e]===b){c.splice(e,1);break}}},dispatchCallback:function(a,b){if(this.callbacks[a])for(var c=0;c<this.callbacks[a].length;c+=1)try{this.callbacks[a][c](this.owner,b)}catch(d){}}},a.RequestManager=function(b){this.loadingBay=document.createDocumentFragment(),this.requestsById={},this.openRequestCount=0,this.maxOpenRequests=4,this.requestQueue=[],this.callbackManager=new a.CallbackManager(this,["requestcomplete"])},a.RequestManager.prototype={loadingBay:null,requestsById:null,requestQueue:null,openRequestCount:null,maxOpenRequests:null,callbackManager:null,addCallback:function(a,b){this.callbackManager.addCallback(a,b)},removeCallback:function(a,b){this.callbackManager.removeCallback(a,b)},dispatchCallback:function(a,b){this.callbackManager.dispatchCallback(a,b)},clear:function(){this.clearExcept({})},clearExcept:function(a){for(var b=0;b<this.requestQueue.length;b++){var c=this.requestQueue[b];c&&!(c.key in a)&&(this.requestQueue[b]=null)}var d=this.loadingBay.childNodes;for(var e=d.length-1;e>=0;e--){var f=d[e];f.id in a||(this.loadingBay.removeChild(f),this.openRequestCount--,f.src=f.coord=f.onload=f.onerror=null)}for(var g in this.requestsById)if(this.requestsById.hasOwnProperty(g)&&!(g in a)){var c=this.requestsById[g];delete this.requestsById[g],c!==null&&(c=c.key=c.coord=c.url=null)}},hasRequest:function(a){return a in this.requestsById},requestTile:function(a,b,c){if(!(a in this.requestsById)){var d={key:a,coord:b.copy(),url:c};this.requestsById[a]=d,c&&this.requestQueue.push(d)}},getProcessQueue:function(){if(!this._processQueue){var a=this;this._processQueue=function(){a.processQueue()}}return this._processQueue},processQueue:function(a){a&&this.requestQueue.length>8&&this.requestQueue.sort(a);while(this.openRequestCount<this.maxOpenRequests&&this.requestQueue.length>0){var b=this.requestQueue.pop();if(b){this.openRequestCount++;var c=document.createElement("img");c.id=b.key,c.style.position="absolute",c.coord=b.coord,this.loadingBay.appendChild(c),c.onload=c.onerror=this.getLoadComplete(),c.src=b.url,b=b.key=b.coord=b.url=null}}},_loadComplete:null,getLoadComplete:function(){if(!this._loadComplete){var a=this;this._loadComplete=function(c){c=c||window.event;var d=c.srcElement||c.target;d.onload=d.onerror=null,a.loadingBay.removeChild(d),a.openRequestCount--,delete a.requestsById[d.id],c.type==="load"&&(d.complete||d.readyState&&d.readyState=="complete")?a.dispatchCallback("requestcomplete",d):d.src=null,setTimeout(a.getProcessQueue(),0)}}return this._loadComplete}},a.Map=function(b,c,d,e){if(typeof b=="string"){b=document.getElementById(b);if(!b)throw"The ID provided to modest maps could not be found."}this.parent=b,this.parent.style.padding="0",this.parent.style.overflow="hidden";var f=a.getStyle(this.parent,"position");f!="relative"&&f!="absolute"&&(this.parent.style.position="relative");if(!d){var g=this.parent.offsetWidth,h=this.parent.offsetHeight;g||(g=640,this.parent.style.width=g+"px"),h||(h=480,this.parent.style.height=h+"px"),d=new a.Point(g,h);var i=this;a.addEvent(window,"resize",function(b){i.dimensions=new a.Point(i.parent.offsetWidth,i.parent.offsetHeight),i.draw(),i.dispatchCallback("resized",[i.dimensions])})}else this.parent.style.width=Math.round(d.x)+"px",this.parent.style.height=Math.round(d.y)+"px";this.dimensions=d,this.requestManager=new a.RequestManager(this.parent),this.requestManager.addCallback("requestcomplete",this.getTileComplete()),this.layers={},this.layerParent=document.createElement("div"),this.layerParent.id=this.parent.id+"-layers",this.layerParent.style.cssText="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; margin: 0; padding: 0; z-index: 0",this.parent.appendChild(this.layerParent),this.coordinate=new a.Coordinate(.5,.5,0),this.setProvider(c),this.enablePyramidLoading=!1,this.callbackManager=new a.CallbackManager(this,["zoomed","panned","centered","extentset","resized","drawn"]);if(e===undefined)this.eventHandlers=[],this.eventHandlers.push(new a.MouseHandler(this));else{this.eventHandlers=e;if(e instanceof Array)for(var j=0;j<e.length;j++)e[j].init(this)}},a.Map.prototype={parent:null,provider:null,dimensions:null,coordinate:null,tiles:null,layers:null,layerParent:null,requestManager:null,tileCacheSize:null,maxTileCacheSize:null,recentTiles:null,recentTilesById:null,recentTileSize:null,callbackManager:null,eventHandlers:null,toString:function(){return"Map(#"+this.parent.id+")"},addCallback:function(a,b){this.callbackManager.addCallback(a,b)},removeCallback:function(a,b){this.callbackManager.removeCallback(a,b)},dispatchCallback:function(a,b){this.callbackManager.dispatchCallback(a,b)},zoomBy:function(b){var c=this;this.coordinate=this.enforceLimits(this.coordinate.zoomBy(b)),a.getFrame(function(){c.draw()}),this.dispatchCallback("zoomed",b);return this},zoomIn:function(){return this.zoomBy(1)},zoomOut:function(){return this.zoomBy(-1)},setZoom:function(a){return this.zoomBy(a-this.coordinate.zoom)},zoomByAbout:function(a,b){var c=this.pointLocation(b);this.coordinate=this.enforceLimits(this.coordinate.zoomBy(a));var d=this.locationPoint(c);this.dispatchCallback("zoomed",a);return this.panBy(b.x-d.x,b.y-d.y)},panBy:function(b,c){var d=this;this.coordinate.column-=b/this.provider.tileWidth,this.coordinate.row-=c/this.provider.tileHeight,this.coordinate=this.enforceLimits(this.coordinate),a.getFrame(function(){d.draw()}),this.dispatchCallback("panned",[b,c]);return this},panLeft:function(){return this.panBy(100,0)},panRight:function(){return this.panBy(-100,0)},panDown:function(){return this.panBy(0,-100)},panUp:function(){return this.panBy(0,100)},setCenter:function(a){return this.setCenterZoom(a,this.coordinate.zoom)},setCenterZoom:function(a,b){this.coordinate=this.provider.locationCoordinate(a).zoomTo(parseFloat(b)||0),this.draw(),this.dispatchCallback("centered",[a,b]);return this},setExtent:function(b){var c,d;for(var e=0;e<b.length;e++){var f=this.provider.locationCoordinate(b[e]);c?(c.row=Math.min(c.row,f.row),c.column=Math.min(c.column,f.column),c.zoom=Math.min(c.zoom,f.zoom),d.row=Math.max(d.row,f.row),d.column=Math.max(d.column,f.column),d.zoom=Math.max(d.zoom,f.zoom)):(c=f.copy(),d=f.copy())}var g=this.dimensions.x+1,h=this.dimensions.y+1,i=(d.column-c.column)/(g/this.provider.tileWidth),j=Math.log(i)/Math.log(2),k=c.zoom-Math.ceil(j),l=(d.row-c.row)/(h/this.provider.tileHeight),m=Math.log(l)/Math.log(2),n=c.zoom-Math.ceil(m),o=Math.min(k,n);o=Math.min(o,this.provider.outerLimits()[1].zoom),o=Math.max(o,this.provider.outerLimits()[0].zoom);var p=(c.row+d.row)/2,q=(c.column+d.column)/2,r=c.zoom;this.coordinate=(new a.Coordinate(p,q,r)).zoomTo(o),this.draw(),this.dispatchCallback("extentset",b);return this},setSize:function(b,c){b.hasOwnProperty("x")&&b.hasOwnProperty("y")?this.dimensions=b:c!==undefined&&!isNaN(c)&&(this.dimensions=new a.Point(b,c)),this.parent.style.width=Math.round(this.dimensions.x)+"px",this.parent.style.height=Math.round(this.dimensions.y)+"px",this.draw(),this.dispatchCallback("resized",[this.dimensions]);return this},coordinatePoint:function(b){b.zoom!=this.coordinate.zoom&&(b=b.zoomTo(this.coordinate.zoom));var c=new a.Point(this.dimensions.x/2,this.dimensions.y/2);c.x+=this.provider.tileWidth*(b.column-this.coordinate.column),c.y+=this.provider.tileHeight*(b.row-this.coordinate.row);return c},pointCoordinate:function(a){var b=this.coordinate.copy();b.column+=(a.x-this.dimensions.x/2)/this.provider.tileWidth,b.row+=(a.y-this.dimensions.y/2)/this.provider.tileHeight;return b},locationPoint:function(a){return this.coordinatePoint(this.provider.locationCoordinate(a))},pointLocation:function(a){return this.provider.coordinateLocation(this.pointCoordinate(a))},getExtent:function(){var b=[];b.push(this.pointLocation(new a.Point(0,0))),b.push(this.pointLocation(this.dimensions));return b},getCenter:function(){return this.provider.coordinateLocation(this.coordinate)},getZoom:function(){return this.coordinate.zoom},setProvider:function(a){var b=!1;this.provider===null&&(b=!0);if(!b){this.requestManager.clear();for(var c in this.layers)if(this.layers.hasOwnProperty(c)){var d=this.layers[c];while(d.firstChild)d.removeChild(d.firstChild)}}this.tiles={},this.tileCacheSize=0,this.maxTileCacheSize=64,this.recentTiles=[],this.recentTilesById={},this.provider=a,b||this.draw();return this},enforceLimits:function(a){a=a.copy();var b=this.provider.outerLimits();if(b){var c=b[0].zoom,d=b[1].zoom;a.zoom<c?a=a.zoomTo(c):a.zoom>d&&(a=a.zoomTo(d))}return a},draw:function(){this.coordinate=this.enforceLimits(this.coordinate);var b=Math.round(this.coordinate.zoom),c=this.pointCoordinate(new a.Point(0,0)).zoomTo(b).container(),d=this.pointCoordinate(this.dimensions).zoomTo(b).container().right().down(),e=0;e&&(c=c.left(e).up(e),d=d.right(e).down(e));var f={},g=this.createOrGetLayer(c.zoom),h=c.copy();for(h.column=c.column;h.column<=d.column;h.column+=1)for(h.row=c.row;h.row<=d.row;h.row+=1){var i=h.toKey();f[i]=!0;if(i in this.tiles){var j=this.tiles[i];j.parentNode!=g&&g.appendChild(j)}else{if(!this.requestManager.hasRequest(i)){var k=this.provider.getTileUrl(h);this.requestManager.requestTile(i,h,k)}var l=!1,m=h.zoom;for(var n=1;n<=m;n++){var o=h.zoomBy(-n).container(),p=o.toKey();if(this.enablePyramidLoading){f[p]=!0;var q=this.createOrGetLayer(o.zoom);if(p in this.tiles){var r=this.tiles[p];r.parentNode!=q&&q.appendChild(r)}else this.requestManager.hasRequest(p)||this.requestManager.requestTile(p,o,this.provider.getTileUrl(o))}else if(p in this.tiles){f[p]=!0,l=!0;break}}if(!l&&!this.enablePyramidLoading){var s=h.zoomBy(1);f[s.toKey()]=!0,s.column+=1,f[s.toKey()]=!0,s.row+=1,f[s.toKey()]=!0,s.column-=1,f[s.toKey()]=!0}}}for(var t in this.layers)if(this.layers.hasOwnProperty(t)){var u=parseInt(t,10);if(u>=c.zoom-5&&u<c.zoom+2)continue;var v=this.layers[t];v.style.display="none";var w=v.getElementsByTagName("img");for(var x=w.length-1;x>=0;x--)v.removeChild(w[x])}var y=(new Date).getTime(),z=c.zoom-5,A=c.zoom+2;for(var B=z;B<A;B++){var v=this.layers[B];if(!v)continue;var C=1,D=this.coordinate.copy(),w=v.getElementsByTagName("img");w.length>0?(v.style.display="block",C=Math.pow(2,this.coordinate.zoom-B),D=D.zoomTo(B)):v.style.display="none";var E=this.provider.tileWidth*C,F=this.provider.tileHeight*C,G=new a.Point(this.dimensions.x/2,this.dimensions.y/2);for(var x=w.length-1;x>=0;x--){var j=w[x];f[j.id]?(a.moveElement(j,{x:Math.round(G.x+(j.coord.column-D.column)*E),y:Math.round(G.y+(j.coord.row-D.row)*F),scale:C,width:this.provider.tileWidth,height:this.provider.tileHeight}),this.recentTilesById[j.id].lastTouchedTime=y):v.removeChild(j)}}this.requestManager.clearExcept(f),this.requestManager.processQueue(this.getCenterDistanceCompare()),this.checkCache(),this.dispatchCallback("drawn")},_tileComplete:null,getTileComplete:function(){if(!this._tileComplete){var b=this;this._tileComplete=function(c,d){b.tiles[d.id]=d,b.tileCacheSize++;var e={id:d.id,lastTouchedTime:(new Date).getTime()};b.recentTilesById[d.id]=e,b.recentTiles.push(e);var f=b.coordinate.zoomTo(d.coord.zoom),g=Math.pow(2,b.coordinate.zoom-d.coord.zoom),h=b.dimensions.x/2+(d.coord.column-f.column)*b.provider.tileWidth*g,i=b.dimensions.y/2+(d.coord.row-f.row)*b.provider.tileHeight*g;a.moveElement(d,{x:Math.round(h),y:Math.round(i),scale:g,width:b.provider.tileWidth,height:b.provider.tileHeight});var j=b.layers[d.coord.zoom];j.appendChild(d),d.className="map-tile-loaded",Math.round(b.coordinate.zoom)===d.coord.zoom&&(j.style.display="block"),b.requestRedraw()}}return this._tileComplete},_redrawTimer:undefined,requestRedraw:function(){this._redrawTimer||(this._redrawTimer=setTimeout(this.getRedraw(),1e3))},_redraw:null,getRedraw:function(){if(!this._redraw){var a=this;this._redraw=function(){a.draw(),a._redrawTimer=0}}return this._redraw},createOrGetLayer:function(a){if(a in this.layers)return this.layers[a];var b=document.createElement("div");b.id=this.parent.id+"-zoom-"+a,b.style.cssText=this.layerParent.style.cssText,b.style.zIndex=a,this.layerParent.appendChild(b),this.layers[a]=b;return b},checkCache:function(){var a=this.parent.getElementsByTagName("img").length,b=Math.max(a,this.maxTileCacheSize);this.tileCacheSize>b&&this.recentTiles.sort(function(a,b){return b.lastTouchedTime<a.lastTouchedTime?-1:b.lastTouchedTime>a.lastTouchedTime?1:0});while(this.tileCacheSize>b){var c=this.recentTiles.pop(),d=(new Date).getTime();delete this.recentTilesById[c.id];var e=this.tiles[c.id];e.parentNode?alert("Gah: trying to removing cached tile even though it's still in the DOM"):(delete this.tiles[c.id],this.tileCacheSize--)}},getCenterDistanceCompare:function(){var a=this.coordinate.zoomTo(Math.round(this.coordinate.zoom));return function(c,d){if(c&&d){var e=c.coord,f=d.coord;if(e.zoom==f.zoom){var g=Math.abs(a.row-e.row-.5)+Math.abs(a.column-e.column-.5),h=Math.abs(a.row-f.row-.5)+Math.abs(a.column-f.column-.5);return g<h?1:g>h?-1:0}return e.zoom<f.zoom?1:e.zoom>f.zoom?-1:0}return c?1:d?-1:0}}},typeof module!="undefined"&&module.exports&&(module.exports={Point:a.Point,Projection:a.Projection,MercatorProjection:a.MercatorProjection,LinearProjection:a.LinearProjection,Transformation:a.Transformation,Location:a.Location,MapProvider:a.MapProvider,TemplatedMapProvider:a.TemplatedMapProvider,Coordinate:a.Coordinate})})(com.modestmaps),!function(context,win){function handleReadyState(a,b,c){return function(){a&&a[readyState]==4&&(twoHundo.test(a.status)?b(a):c(a))}}function setHeaders(a,b){var c=b.headers||{};c.Accept=c.Accept||"text/javascript, text/html, application/xml, text/xml, */*",b.crossOrigin||(c["X-Requested-With"]=c["X-Requested-With"]||"XMLHttpRequest"),c[contentType]=c[contentType]||"application/x-www-form-urlencoded";for(var d in c)c.hasOwnProperty(d)&&a.setRequestHeader(d,c[d],!1)}function getCallbackName(a){var b=a.jsonpCallback||"callback";if(a.url.slice(-(b.length+2))==b+"=?"){var c="reqwest_"+uniqid++;a.url=a.url.substr(0,a.url.length-1)+c;return c}var d=new RegExp(b+"=([\\w]+)");return a.url.match(d)[1]}function generalCallback(a){lastValue=a}function getRequest(a,b,c){if(a.type!="jsonp"){var d=xhr();d.open(a.method||"GET",typeof a=="string"?a:a.url,!0),setHeaders(d,a),d.onreadystatechange=handleReadyState(d,b,c),a.before&&a.before(d),d.send(a.data||null);return d}var e=doc.createElement("script"),f=0;win[getCallbackName(a)]=generalCallback,e.type="text/javascript",e.src=a.url,e.async=!0,e.onload=e.onreadystatechange=function(){if(e[readyState]&&e[readyState]!=="complete"&&e[readyState]!=="loaded"||f)return!1;e.onload=e.onreadystatechange=null,a.success&&a.success(lastValue),lastValue=undefined,head.removeChild(e),f=1},head.appendChild(e)}function Reqwest(a,b){this.o=a,this.fn=b,init.apply(this,arguments)}function setType(a){if(/\.json$/.test(a))return"json";if(/\.jsonp$/.test(a))return"jsonp";if(/\.js$/.test(a))return"js";if(/\.html?$/.test(a))return"html";if(/\.xml$/.test(a))return"xml";return"js"}function init(o,fn){function complete(a){o.complete&&o.complete(a)}function success(resp){o.timeout&&clearTimeout(self.timeout)&&(self.timeout=null);var r=resp.responseText;if(r)switch(type){case"json":resp=win.JSON?win.JSON.parse(r):eval("("+r+")");break;case"js":resp=eval(r);break;case"html":resp=r}fn(resp),o.success&&o.success(resp),complete(resp)}function error(a){o.error&&o.error(a),complete(a)}this.url=typeof o=="string"?o:o.url,this.timeout=null;var type=o.type||setType(this.url),self=this;fn=fn||function(){},o.timeout&&(this.timeout=setTimeout(function(){self.abort(),error()},o.timeout)),this.request=getRequest(o,success,error)}function reqwest(a,b){return new Reqwest(a,b)}function enc(a){return encodeURIComponent(a)}function serial(a){var b=a.name;if(a.disabled||!b)return"";b=enc(b);switch(a.tagName.toLowerCase()){case"input":switch(a.type){case"reset":case"button":case"image":case"file":return"";case"checkbox":case"radio":return a.checked?b+"="+(a.value?enc(a.value):!0)+"&":"";default:return b+"="+(a.value?enc(a.value):"")+"&"}break;case"textarea":return b+"="+enc(a.value)+"&";case"select":return b+"="+enc(a.options[a.selectedIndex].value)+"&"}return""}var twoHundo=/^20\d$/,doc=document,byTag="getElementsByTagName",readyState="readyState",contentType="Content-Type",head=doc[byTag]("head")[0],uniqid=0,lastValue,xhr="XMLHttpRequest"in win?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")};Reqwest.prototype={abort:function(){this.request.abort()},retry:function(){init.call(this,this.o,this.fn)}},reqwest.serialize=function(a){var b=[a[byTag]("input"),a[byTag]("select"),a[byTag]("textarea")],c=[],d,e;for(d=0,l=b.length;d<l;++d)for(e=0,l2=b[d].length;e<l2;++e)c.push(serial(b[d][e]));return c.join("").replace(/&$/,"")},reqwest.serializeArray=function(a){for(var b=this.serialize(a).split("&"),c=0,d=b.length,e=[],f;c<d;c++)b[c]&&(f=b[c].split("="))&&e.push({name:f[0],value:f[1]});return e};var old=context.reqwest;reqwest.noConflict=function(){context.reqwest=old;return this},typeof module!="undefined"?module.exports=reqwest:context.reqwest=reqwest}(this,window);var wax=wax||{};Array.prototype.reduce||(Array.prototype.reduce=function(a){"use strict";if(this===void 0||this===null)throw new TypeError;var b=Object(this),c=b.length>>>0;if(typeof a!="function")throw new TypeError;if(c==0&&arguments.length==1)throw new TypeError;var d=0,e;if(arguments.length>=2)e=arguments[1];else do{if(d in b){e=b[d++];break}if(++d>=c)throw new TypeError}while(!0);while(d<c)d in b&&(e=a.call(undefined,e,b[d],d,b)),d++;return e}),wax.Record=function(a,b){var c=function(a,b){var c=a.split(".").reduce(function(a,b){return[a[1]||a[0],a[1]?a[1][b]:a[0][b]]},[b||window,null]);if(c[0]&&c[1])return c;throw a+" not found."},d=function(a,b){var d=c(a),e;b=b.length?wax.Record(b):[];if(Object.create)e=Object.create(d[1].prototype),d[1].apply(e,b);else switch(b.length){case 0:e=new d[1];break;case 1:e=new d[1](b[0]);break;case 2:e=new d[1](b[0],b[1]);break;case 3:e=new d[1](b[0],b[1],b[2]);break;case 4:e=new d[1](b[0],b[1],b[2],b[3]);break;case 5:e=new d[1](b[0],b[1],b[2],b[3],b[4]);break;default:}return e},e=function(a,b,d){var e=c(a,d),f=b.length?wax.Record(b):[];return d&&a.indexOf(".")===-1?e[1].apply(d,f):e[1].apply(e[0],f)},f=function(a){return wax.util.isString(a)&&wax.util.indexOf(["@new","@call","@literal","@chain","@inject","@group"],a.split(" ")[0])!==-1},g=function(a){return wax.util.isString(a)&&wax.util.indexOf(["@new","@call","@chain"],a.split(" ")[0])!==-1},h=function(a){if(wax.util.isArray(a)&&a[0]&&f(a[0]))return{verb:a[0].split(" ")[0],subject:a[0].split(" ")[1],object:a.slice(1)};return!1},i,j=!1,k=null,l=null,m=h(a);if(!m){if(a!==null&&typeof a=="object"){var n=wax.util.keys(a);for(i=0;i<n.length;i++){var o=n[i];a[o]=wax.Record(a[o],b)}return a}return a}switch(m.verb){case"@group":for(i=0;i<m.object.length;i++)k=wax.Record(m.object[i],b),l=h(m.object[i]),l&&g(l.verb)&&(b=k);return b;case"@new":return d(m.subject,m.object);case"@literal":j=c(m.subject);return j?j[1]:null;case"@inject":return e(m.subject,m.object,b);case"@chain":return e(m.subject,m.object,b);case"@call":return e(m.subject,m.object,null)}},wax=wax||{},wax.attribution=function(){var a,b={};b.set=function(b){if(typeof b!="undefined"){a.innerHTML=b;return this}},b.element=function(){return a},b.init=function(){a=document.createElement("div"),a.className="wax-attribution";return this};return b.init()},wax=wax||{},wax.bwdetect=function(a,b){function h(){wax.bw=-1;var a=new Image;a.src=e;var b=!0,f=setTimeout(function(){b&&wax.bw==-1&&(c.bw(0),b=!1)},d);a.onload=function(){b&&wax.bw==-1&&(clearTimeout(f),c.bw(1),b=!1)}}var c={},d=a.threshold||400,e="http://a.tiles.mapbox.com/mapbox/1.0.0/blue-marble-topo-bathy-jul/0/0/0.png?preventcache="+ +(new Date),f=1,g=a.auto===undefined?!0:a.auto;c.bw=function(a){if(!arguments.length)return f;var c=f;wax.bwlisteners&&wax.bwlisteners.length&&function(){listeners=wax.bwlisteners,wax.bwlisteners=[];for(i=0;i<listeners;i++)listeners[i](a)}(),wax.bw=a,f!=(f=a)&&b(a)},c.add=function(){g&&h();return this},wax.bw==-1?(wax.bwlisteners=wax.bwlisteners||[],wax.bwlisteners.push(c.bw)):wax.bw!==undefined?c.bw(wax.bw):c.add();return c},wax.formatter=function(x){var formatter={},f;if(x&&typeof x=="string")try{eval("f = "+x)}catch(e){console&&console.log(e)}else x&&typeof x=="function"?f=x:f=function(){};formatter.format=function(a,b){try{return f(a,b)}catch(c){console&&console.log(c)}};return formatter},wax.GridInstance=function(a,b,c){function f(a){a>=93&&a--,a>=35&&a--,a-=32;return a}c=c||{};var d={},e=c.resolution||4;tileSize=c.tileSize||256,d.gridFeature=function(b,c){if(!!a&&!!a.grid){if(c<0||b<0)return;if(Math.floor(c)>tileSize||Math.floor(b)>tileSize)return;var d=f(a.grid[Math.floor(c/e)].charCodeAt(Math.floor(b/e)));if(a.keys[d]&&a.data[a.keys[d]])return a.data[a.keys[d]]}},d.tileFeature=function(a,c,d,e){var f=wax.util.offset(d);feature=this.gridFeature(a-f.left,c-f.top);if(feature)return b.format(e,feature)};return d},wax.GridManager=function(a){function i(a){typeof a=="string"&&(a=[a]);return function(c){if(!!c){var d=/(\d+)\/(\d+)\/(\d+)\.[\w\._]+/g.exec(c);if(!d)return;return a[parseInt(d[2],10)%a.length].replace("{z}",d[1]).replace("{x}",d[2]).replace("{y}",d[3])}}}function h(a,b){if(typeof e!="undefined")return b(null,e);wax.request.get(f(a),function(a,c){c&&c.formatter?e=wax.formatter(c.formatter):e=!1;return b(a,e)})}a=a||{};var b=a.resolution||4,c={},d={},e,f=function(a){return a.replace(/\d+\/\d+\/\d+\.\w+/,"layer.json")},g=function(a){return a.replace(/(\.png|\.jpg|\.jpeg)(\d*)/,".grid.json")};d.formatter=function(a){if(!arguments.length)return e;e=wax.formatter(a);return d},d.formatterUrl=function(a){if(!arguments.length)return f;f=typeof a=="string"?function(){return a}:a;return d},d.gridUrl=function(a){if(!arguments.length)return g;g=typeof a=="function"?a:i(a);return d},d.getGrid=function(a,c){h(a,function(d,e){var f=g(a);if(d||!e||!f)return c(d,null);wax.request.get(f,function(a,d){if(a)return c(a,null);c(null,wax.GridInstance(d,e,{resolution:b||4}))})});return d},a.formatter&&d.formatter(a.formatter),a.grids&&d.gridUrl(a.grids);return d};var wax=wax||{};wax.legend=function(){var a,b={},c;b.element=function(){return c},b.content=function(b){if(!arguments.length)return a.innerHTML;b?(a.innerHTML=b,a.style.display="block"):(a.innerHTML="",a.style.display="none");return this},b.add=function(){c=document.createElement("div"),c.className="wax-legends",a=document.createElement("div"),a.className="wax-legend",a.style.display="none",c.appendChild(a);return this};return b.add()};var w=function(a){a.melt=function(b,c){return b.apply(c,[a,c])};return a},wax=wax||{};wax.request={cache:{},locks:{},promises:{},get:function(a,b){if(this.cache[a])return b(this.cache[a][0],this.cache[a][1]);this.promises[a]=this.promises[a]||[],this.promises[a].push(b);if(!this.locks[a]){var c=this;this.locks[a]=!0,reqwest({url:a+"?callback=grid",type:"jsonp",jsonpCallback:"callback",success:function(b){c.locks[a]=!1,c.cache[a]=[null,b];for(var d=0;d<c.promises[a].length;d++)c.promises[a][d](c.cache[a][0],c.cache[a][1])},error:function(b){c.locks[a]=!1,c.cache[a]=[b,null];for(var d=0;d<c.promises[a].length;d++)c.promises[a][d](c.cache[a][0],c.cache[a][1])}})}}};if(!wax)var wax={};wax.tilejson=function(a,b){reqwest({url:a+"?callback=grid",type:"jsonp",jsonpCallback:"callback",success:b,error:b})};var wax=wax||{};wax.tooltip={},wax.tooltip=function(a){this._currentTooltip=undefined,a=a||{},a.animationOut&&(this.animationOut=a.animationOut),a.animationIn&&(this.animationIn=a.animationIn)},wax.tooltip.prototype.isPopup=function(a){return a&&a.className.indexOf("wax-popup")!==-1},wax.tooltip.prototype.getTooltip=function(a,b,c,d){tooltip=document.createElement("div"),tooltip.className="wax-tooltip wax-tooltip-"+c,tooltip.innerHTML=a,b.appendChild(tooltip);return tooltip},wax.tooltip.prototype.hideTooltip=function(a){if(!!a){var b,c=function(){this.parentNode&&this.parentNode.removeChild(this)};a.style["-webkit-transition"]!==undefined&&this.animationOut?b="webkitTransitionEnd":a.style.MozTransition!==undefined&&this.animationOut&&(b="transitionend"),b?(a.addEventListener(b,c,!1),a.addEventListener("transitionend",c,!1),a.className+=" "+this.animationOut):a.parentNode&&a.parentNode.removeChild(a)}},wax.tooltip.prototype.click=function(a,b,c){this.unselect(b);var d=this.getTooltip(a,b,c),e=document.createElement("a");e.href="#close",e.className="close",e.innerHTML="Close";var f=wax.util.bind(function(a){this.hideTooltip(d),this._currentTooltip=undefined,a.returnValue=!1,a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault();return!1},this);e.addEventListener?e.addEventListener("click",f,!1):e.attachEvent&&e.attachEvent("onclick",f),d.className+=" wax-popup",d.innerHTML=a,d.appendChild(e),this._currentTooltip=d},wax.tooltip.prototype.select=function(a,b,c,d){if(!!a){if(this.isPopup(this._currentTooltip))return;this._currentTooltip=this.getTooltip(a,b,c,d),b.style.cursor="pointer"}},wax.tooltip.prototype.unselect=function(a){this.isPopup(this._currentTooltip)||(a.style.cursor="default",this._currentTooltip&&(this.hideTooltip(this._currentTooltip),this._currentTooltip=undefined))},wax.tooltip.prototype.out=wax.tooltip.prototype.unselect,wax.tooltip.prototype.over=wax.tooltip.prototype.select,wax.tooltip.prototype.click=wax.tooltip.prototype.click;var wax=wax||{};wax.util=wax.util||{},wax.util={offset:function(a){var b=a.offsetWidth||parseInt(a.style.width,10),c=a.offsetHeight||parseInt(a.style.height,10),d=0,e=0,f=function(a){if(a!==document.body&&a!==document.documentElement){d+=a.offsetTop,e+=a.offsetLeft;var b=a.style.transform||a.style.WebkitTransform||a.style.OTransform||a.style.MozTransform||a.style.msTransform;if(b)if(match=b.match(/translate\((.+)px, (.+)px\)/))d+=parseInt(match[2],10),e+=parseInt(match[1],10);else if(match=b.match(/translate3d\((.+)px, (.+)px, (.+)px\)/))d+=parseInt(match[2],10),e+=parseInt(match[1],10);else if(match=b.match(/matrix3d\(([\-\d,\s]+)\)/)){var c=match[1].split(",");d+=parseInt(c[13],10),e+=parseInt(c[12],10)}else if(match=b.match(/matrix\(.+, .+, .+, .+, (.+), (.+)\)/))d+=parseInt(match[2],10),e+=parseInt(match[1],10)}};f(a);try{while(a=a.offsetParent)f(a)}catch(g){}d+=document.body.offsetTop,e+=document.body.offsetLeft,d+=document.body.parentNode.offsetTop,e+=document.body.parentNode.offsetLeft;var h=document.defaultView?window.getComputedStyle(document.body.parentNode,null):document.body.parentNode.currentStyle;document.body.parentNode.offsetTop!==parseInt(h.marginTop,10)&&!isNaN(parseInt(h.marginTop,10))&&(d+=parseInt(h.marginTop,10),e+=parseInt(h.marginLeft,10));return{top:d,left:e,height:c,width:b}},$:function(a){return typeof a=="string"?document.getElementById(a):a},bind:function(a,b){var c=Array.prototype.slice.call(arguments,2);return function(){return a.apply(b,c.concat(Array.prototype.slice.call(arguments)))}},isString:function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)},indexOf:function(a,b){var c=Array.prototype.indexOf;if(a===null)return-1;var d,e;if(c&&a.indexOf===c)return a.indexOf(b);for(d=0,e=a.length;d<e;d++)if(a[d]===b)return d;return-1},isArray:Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},keys:Object.keys||function(a){var b=Object.prototype.hasOwnProperty;if(a!==Object(a))throw new TypeError("Invalid object");var c=[];for(var d in a)b.call(a,d)&&(c[c.length]=d);return c},eventoffset:function(a){var b=0,c=0;if(!a)var a=window.event;if(a.pageX||a.pageY)return{x:a.pageX,y:a.pageY};if(a.clientX||a.clientY){var d=document.documentElement,e=document.body,f=document.body.parentNode.currentStyle,g=parseInt(f.marginTop,10)||0,h=parseInt(f.marginLeft,10)||0;return{x:a.clientX+(d&&d.scrollLeft||e&&e.scrollLeft||0)-(d&&d.clientLeft||e&&e.clientLeft||0)+h,y:a.clientY+(d&&d.scrollTop||e&&e.scrollTop||0)-(d&&d.clientTop||e&&e.clientTop||0)+g}}if(a.touches&&a.touches.length===1)return{x:a.touches[0].pageX,y:a.touches[0].pageY}}},wax=wax||{},wax.mm=wax.mm||{},wax.mm.attribution=function(a,b){b=b||{};var c,d={};d.element=function(){return c.element()},d.appendTo=function(a){wax.util.$(a).appendChild(c.element());return this},d.init=function(){c=wax.attribution(),c.set(b.attribution),c.element().className="wax-attribution wax-mm";return this};return d.init()},wax=wax||{},wax.mm=wax.mm||{},wax.mm.boxselector=function(a,b,c){function n(a,b){if(!!g&&!!h){var c=a.locationPoint(h[0]),d=a.locationPoint(h[1]);g.style.display="block",g.style.height="auto",g.style.width="auto",g.style.left=Math.max(0,d.x)+"px",g.style.top=Math.max(0,d.y)+"px",g.style.right=Math.max(0,a.dimensions.x-c.x)+"px",g.style.bottom=Math.max(0,a.dimensions.y-c.y)+"px"}}function m(b){var c=j(b),g=a.pointLocation(c),i=a.pointLocation(d),k=[new e.Location(Math.max(g.lat,i.lat),Math.min(g.lon,i.lon)),new e.Location(Math.min(g.lat,i.lat),Math.max(g.lon,i.lon))];h=[g,i],f(k),e.removeEvent(a.parent,"mousemove",l),e.removeEvent(a.parent,"mouseup",m),a.parent.style.cursor="auto"}function l(a){var b=j(a);g.style.display="block",b.x<d.x?g.style.left=b.x+"px":g.style.left=d.x+"px",b.y<d.y?g.style.top=b.y+"px":g.style.top=d.y+"px",g.style.width=Math.abs(b.x-d.x)+"px",g.style.height=Math.abs(b.y-d.y)+"px";return e.cancelEvent(a)}function k(b){if(!!b.shiftKey){d=j(b),g.style.left=d.x+"px",g.style.top=d.y+"px",e.addEvent(a.parent,"mousemove",l),e.addEvent(a.parent,"mouseup",m),a.parent.style.cursor="crosshair";return e.cancelEvent(b)}}function j(b){var c=new e.Point(b.clientX,b.clientY);c.x+=document.body.scrollLeft+document.documentElement.scrollLeft,c.y+=document.body.scrollTop+document.documentElement.scrollTop;for(var d=a.parent;d;d=d.offsetParent)c.x-=d.offsetLeft,c.y-=d.offsetTop;return c}var d=null,e=com.modestmaps,f=typeof c=="function"?c:c.callback,g,h,i={};i.add=function(a){g=g||document.createElement("div"),g.id=a.parent.id+"-boxselector-box",g.className="boxselector-box",a.parent.appendChild(g),e.addEvent(a.parent,"mousedown",k),a.addCallback("drawn",n);return this},i.remove=function(){a.parent.removeChild(g),e.removeEvent(a.parent,"mousedown",k),a.removeCallback("drawn",n)};return i.add(a)},wax=wax||{},wax.mm=wax.mm||{},wax.mm.bwdetect=function(a,b){function g(b){(!b.options||!b.options.scheme)&&e.Map.prototype.setProvider.call(a,b);var g=[[".png",".jpg"],[c,d]];f&&g.reverse();for(var h=0;h<b.options.tiles.length;h++)b.options.tiles[h]=b.options.tiles[h].replace(g[0][0],g[1][0]).replace(g[0][1],g[1][1]);e.Map.prototype.setProvider.call(a,b)}b=b||{};var c=b.png||".png128",d=b.jpg||".jpg70",e=com.modestmaps,f=1;a.setProvider=g;return wax.bwdetect(b,function(b){f=b,g(a.provider)})},wax=wax||{},wax.mm=wax.mm||{},wax.mm.fullscreen=function(a){function f(a){a&&com.modestmaps.cancelEvent(a),b?c.original():c.full()}var b=!1,c={},d,e;c.add=function(a){d=document.createElement("a"),d.className="wax-fullscreen",d.href="#fullscreen",d.innerHTML="fullscreen",com.modestmaps.addEvent(d,"click",f);return this},c.full=function(){b||(b=!0,e=[a.parent.offsetWidth,a.parent.offsetHeight],a.parent.className+=" wax-fullscreen-map",a.setSize(a.parent.offsetWidth,a.parent.offsetHeight))},c.original=function(){!b||(b=!1,a.parent.className=a.parent.className.replace("wax-fullscreen-map",""),a.setSize(e[0],e[1]))},c.appendTo=function(a){wax.util.$(a).appendChild(d);return this};return c.add(a)},wax=wax||{},wax.mm=wax.mm||{},wax.mm.locationHash={stateChange:function(a){com.modestmaps.addEvent(window,"hashchange",function(){a(location.hash.substring(1))},!1)},getState:function(){return location.hash.substring(1)},pushState:function(a){location.hash="#"+a}},wax.mm.pushState={stateChange:function(a){com.modestmaps.addEvent(window,"popstate",function(b){b.state&&b.state.map_location&&a(b.state.map_location)},!1)},getState:function(){if(!!window.history&&!!window.history.state)return history.state&&history.state.map_location},pushState:function(a){!!window.history&&!!window.history.pushState&&window.history.pushState({map_location:a},document.title,window.location.href)}},wax.mm.hash=function(a,b,c){function l(a){a!==d&&i(d=a)&&k()}function k(){var a=j();d!==a&&(d=a,c.manager.pushState(d))}function h(a,b){return g(a,b,!1)}function g(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,a.apply(e,f)};c&&clearTimeout(d);if(c||!d)d=setTimeout(g,b)}}c=c||{};var d,e={},f=90-1e-8;c.manager=c.manager||wax.mm.pushState;var i=function(b){var c=b.split("/");for(var d=0;d<c.length;d++){c[d]=Number(c[d]);if(isNaN(c[d]))return!0}if(c.length<3)return!0;c.length==3&&a.setCenterZoom(new com.modestmaps.Location(c[1],c[2]),c[0])},j=function(){var b=a.getCenter(),c=a.getZoom(),d=Math.max(0,Math.ceil(Math.log(c)/Math.LN2));return[c.toFixed(2),b.lat.toFixed(d),b.lon.toFixed(d)].join("/")},m=function(){c.defaultCenter&&a.setCenter(c.defaultCenter),c.defaultZoom&&a.setZoom(c.defaultZoom)};e.add=function(a){c.manager.getState()?l(c.manager.getState()):(m(),k()),a.addCallback("drawn",h(k,500)),c.manager.stateChange(l);return this};return e.add(a)},wax=wax||{},wax.mm=wax.mm||{},wax.mm.interaction=function(a,b,c){function y(b,c){var d=s(c),i;d&&e.getGrid(d.src,function(e,j){for(var k=0;j&&k<g.length;k++)if(i=j.tileFeature(c.x,c.y,d,{format:g[k]}))switch(g[k]){case"full":case"teaser":return f.click(i,a.parent,0,b);case"location":return h(i)}})}function x(b){var c=wax.util.eventoffset(b);d.removeEvent(document.body,"mouseup",x),a.parent.ontouchend&&(d.removeEvent(a.parent,"touchend",x),d.removeEvent(a.parent,"touchmove",_touchCancel)),j=!1,b.type==="touchend"?y(b,n):Math.round(c.y/o)===Math.round(n.y/o)&&Math.round(c.x/o)===Math.round(n.x/o)&&(k=window.setTimeout(function(a){return function(b){k=null,y(b,a)}}(c),300));return x}function w(){d.removeEvent(a.parent,"touchend",x),d.removeEvent(a.parent,"touchmove",x),j=!1}function v(b){t()||(j=!0,n=wax.util.eventoffset(b),b.type==="mousedown"?d.addEvent(document.body,"mouseup",x):b.type==="touchstart"&&b.touches.length===1&&(g=["full","teaser"],f._currentTooltip&&f.hideTooltip(f._currentTooltip),d.addEvent(a.parent,"touchend",x),d.addEvent(a.parent,"touchmove",w)))}function u(b){if(!j){var c=wax.util.eventoffset(b),d=s(c),g;d&&e.getGrid(d.src,function(e,h){!e&&!!h&&((g=h.tileFeature(c.x,c.y,d,{format:"teaser"}))?g&&m!==g?(m=g,f.out(a.parent),f.over(g,a.parent,0,b)):g||(m=null,f.out(a.parent)):(m=null,f.out(a.parent)))})}}function t(){if(k){window.clearTimeout(k),k=null;return!0}return!1}function s(a){for(var b=0,c=q();b<c.length;b++)if(c[b][0]<a.y&&c[b][0]+256>a.y&&c[b][1]<a.x&&c[b][1]+256>a.x)return c[b][2];return!1}function r(a,b){p=null}function q(){var b=a.createOrGetLayer(Math.round(a.getZoom()));return p||(p=function(a){var c=[];for(var d in a)if(a[d].parentNode===b){var e=wax.util.offset(a[d]);c.push([e.top,e.left,a[d]])}return c}(a.tiles))}c=c||{},b=b||{};var d=com.modestmaps,e=wax.GridManager(b),f=c.callbacks||new wax.tooltip(c),g=c.clickAction||["full","location"],h=c.clickHandler||function(a){window.location=a},i={},j=!1,k=!1,l="ontouchstart"in document.documentElement,m,n,o=4,p;i.add=function(){var b=["zoomed","panned","centered","extentset","resized","drawn"];for(var c=0;c<b.length;c++)a.addCallback(b[c],r);d.addEvent(a.parent,"mousemove",u),d.addEvent(a.parent,"mousedown",v),l&&d.addEvent(a.parent,"touchstart",v);return this},i.remove=function(){var b=["zoomed","panned","centered","extentset","resized","drawn"];for(var c=0;c<b.length;c++)a.removeCallback(b[c],r);d.removeEvent(a.parent,"mousemove",u),d.removeEvent(a.parent,"mousedown",v),l&&d.removeEvent(a.parent,"touchstart",v),f._currentTooltip&&f.hideTooltip(f._currentTooltip);return this};return i.add(a)},wax=wax||{},wax.mm=wax.mm||{},wax.mm.legend=function(a,b){b=b||{};var c,d={};d.add=function(){c=wax.legend().content(b.legend||"");return this},d.content=function(a){a&&c.content(a.legend||"")},d.element=function(){return c.element()},d.appendTo=function(a){wax.util.$(a).appendChild(c.element());return this};return d.add()},wax=wax||{},wax.mm=wax.mm||{},wax.mm.mobile=function(a,b,c){c=c||{};var d=com.modestmaps,e=navigator.userAgent.toLowerCase(),f=e.indexOf("webkit")!=-1,g=e.indexOf("mobile")!=-1,h=g&&f,i=function(a){var b=document.createElement("canvas"),c=parseInt(a.style.width,10),d=parseInt(a.style.height,10),e=c/2,f=d/2,g=Math.min(c,d)/4,h=b.getContext("2d");b.setAttribute("width",c),b.setAttribute("height",d),h.globalAlpha=.5;var i=h.createLinearGradient(0,0,300,225);i.addColorStop(0,"black"),i.addColorStop(1,"rgb(200, 200, 200)"),h.fillStyle=i,h.fillRect(0,0,c,d),h.fillStyle="rgb(255, 255, 255)",h.beginPath(),h.moveTo(e-g*.6,f-g),h.lineTo(e-g*.6,f+g),h.lineTo(e+g*.6,f),h.fill(),a.appendChild(b)},j=function(a){a.style.position="absolute",a.style.height="50px",a.style.left=a.style.right="0";var b=document.createElement("canvas");b.setAttribute("width",a.offsetWidth),b.setAttribute("height",a.offsetHeight);var c=b.getContext("2d");c.globalAlpha=1,c.fillStyle="rgba(255, 255, 255, 0.5)",c.fillRect(0,0,a.offsetWidth,a.offsetHeight),c.fillStyle="rgb(0, 0, 0)",c.font="bold 20px sans-serif",c.fillText("back",20,30),a.appendChild(b)},k=function(a){a.style.position="absolute",a.style.width=a.style.height="auto",a.style.top=window.pageYOffset+"px",a.style.left=a.style.right="0px"},l=function(a){a.style.position="relative",a.style.width=a.style.height=a.style.top=a.style.left=a.style.right="auto"},m,n,o,p,q=c.overlayDraw||i,r=c.backDraw||j;bodyDraw=c.bodyDraw||function(){};var s={add:function(a){h&&(p=document.createElement("meta"),p.id="wax-touch",p.setAttribute("name","viewport"),m=document.createElement("div"),m.id=a.parent.id+"-mobileoverlay",m.className="wax-mobileoverlay",m.style.position="absolute",m.style.width=a.dimensions.x+"px",m.style.height=a.dimensions.y+"px",a.parent.appendChild(m),q(m),o=document.createElement("div"),backDiv=document.createElement("div"),n=document.body,newBody=document.createElement("body"),newBody.className="wax-mobile-body",newBody.appendChild(backDiv),d.addEvent(m,"touchstart",this.toTouch),d.addEvent(backDiv,"touchstart",this.toPage));return this},toTouch:function(){a.parent.parentNode.replaceChild(o,a.parent),newBody.insertBefore(a.parent,backDiv),document.body=newBody,bodyDraw(newBody),r(backDiv),p.setAttribute("content","initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0"),document.head.appendChild(p),a._smallSize=[a.parent.clientWidth,a.parent.clientHeight],k(a.parent),a.setSize(a.parent.offsetWidth,window.innerHeight),backDiv.style.display="block",m.style.display="none"},toPage:function(){document.body=n,o.parentNode.replaceChild(a.parent,o),l(a.parent),a.setSize(a._smallSize[0],a._smallSize[1]),backDiv.style.display="none",m.style.display="block"}};return s.add(a)},wax=wax||{},wax.mm=wax.mm||{},wax.mm.pointselector=function(a,b,c){function p(b){!d||(e=l(b),h.Point.distance(d,e)<f&&(i.addLocation(a.pointLocation(d)),k(m(j))),d=null)}function o(b){d=l(b),h.addEvent(a.parent,"mouseup",p)}function n(){var b=new h.Point(0,0);for(var c=0;c<j.length;c++){var d=a.locationPoint(j[c]);j[c].pointDiv||(j[c].pointDiv=document.createElement("div"),j[c].pointDiv.className="wax-point-div",j[c].pointDiv.style.position="absolute",j[c].pointDiv.style.display="block",j[c].pointDiv.location=j[c],h.addEvent(j[c].pointDiv,"mouseup",function(d){var e=j[c];return function(b){h.removeEvent(a.parent,"mouseup",p),i.deletePoint(e,b)}}()),a.parent.appendChild(j[c].pointDiv)),j[c].pointDiv.style.left=d.x+"px",j[c].pointDiv.style.top=d.y+"px"}}function m(a){var b=[];for(var c=0;c<a.length;c++)b.push(new h.Location(a[c].lat,a[c].lon));return b}function l(b){var c=wax.util.eventoffset(b),d=new h.Point(c.x,c.y),e={x:parseFloat(h.getStyle(document.documentElement,"margin-left")),y:parseFloat(h.getStyle(document.documentElement,"margin-top"))};isNaN(e.x)||(d.x-=e.x),isNaN(e.y)||(d.y-=e.y);for(var f=a.parent;f;f=f.offsetParent)d.x-=f.offsetLeft,d.y-=f.offsetTop;return d}var d=null,e=null,f=5,g,h=com.modestmaps,i={},j=[],k=typeof c=="function"?c:c.callback;i.addLocation=function(a){j.push(a),n(),k(m(j))},i.add=function(a){h.addEvent(a.parent,"mousedown",o),a.addCallback("drawn",n());return this},i.deletePoint=function(a,b){confirm("Delete this point?")&&(a.pointDiv.parentNode.removeChild(a.pointDiv),j.splice(wax.util.indexOf(j,a),1),k(m(j)))};return i.add(a)},wax=wax||{},wax.mm=wax.mm||{},wax.mm.zoombox=function(a){function j(a){if(!!d){var b=g(a);e.style.display="block",b.x<f.x?e.style.left=b.x+"px":e.style.left=f.x+"px",e.style.width=Math.abs(b.x-f.x)+"px",b.y<f.y?e.style.top=b.y+"px":e.style.top=f.y+"px",e.style.height=Math.abs(b.y-f.y)+"px";return c.cancelEvent(a)}}function i(b){if(!!b.shiftKey&&!this.drawing){d=!0,f=g(b),e.style.left=f.x+"px",e.style.top=f.y+"px",c.addEvent(a.parent,"mousemove",j),c.addEvent(a.parent,"mouseup",h),a.parent.style.cursor="crosshair";return c.cancelEvent(b)}}function h(b){if(!!d){d=!1;var i=g(b),k=a.pointLocation(i),l=a.pointLocation(f);a.setExtent([k,l]),e.style.display="none",c.removeEvent(a.parent,"mousemove",j),c.removeEvent(a.parent,"mouseup",h),a.parent.style.cursor="auto"}}function g(b){var d=new c.Point(b.clientX,b.clientY);d.x+=document.body.scrollLeft+document.documentElement.scrollLeft,d.y+=document.body.scrollTop+document.documentElement.scrollTop;for(var e=a.parent;e;e=e.offsetParent)d.x-=e.offsetLeft,d.y-=e.offsetTop;return d}var b={},c=com.modestmaps,d=!1,e,f=null;b.add=function(a){e=e||document.createElement("div"),e.id=a.parent.id+"-zoombox-box",e.className="zoombox-box",a.parent.appendChild(e),c.addEvent(a.parent,"mousedown",i);return this},b.remove=function(){a.parent.removeChild(e),c.removeEvent(a.parent,"mousedown",i)};return b.add(a)},wax=wax||{},wax.mm=wax.mm||{},wax.mm.zoomer=function(a){var b=com.modestmaps,c=document.createElement("a");c.innerHTML="+",c.href="#",c.className="zoomer zoomin",b.addEvent(c,"mousedown",function(a){b.cancelEvent(a)}),b.addEvent(c,"dblclick",function(a){b.cancelEvent(a)}),b.addEvent(c,"click",function(c){b.cancelEvent(c),a.zoomIn()},!1);var d=document.createElement("a");d.innerHTML="-",d.href="#",d.className="zoomer zoomout",b.addEvent(d,"mousedown",function(a){b.cancelEvent(a)}),b.addEvent(d,"dblclick",function(a){b.cancelEvent(a)}),b.addEvent(d,"click",function(c){b.cancelEvent(c),a.zoomOut()},!1);var e={add:function(a){a.addCallback("drawn",function(a,b){a.coordinate.zoom===a.provider.outerLimits()[0].zoom?d.className="zoomer zoomout zoomdisabled":a.coordinate.zoom===a.provider.outerLimits()[1].zoom?c.className="zoomer zoomin zoomdisabled":(c.className="zoomer zoomin",d.className="zoomer zoomout")});return this},appendTo:function(a){wax.util.$(a).appendChild(c),wax.util.$(a).appendChild(d);return this}};return e.add(a)};var wax=wax||{};wax.mm=wax.mm||{},wax.mm.connector=function(a){this.options={tiles:a.tiles,scheme:a.scheme||"xyz",minzoom:a.minzoom||0,maxzoom:a.maxzoom||22}},wax.mm.connector.prototype={outerLimits:function(){return[(new com.modestmaps.Coordinate(0,0,0)).zoomTo(this.options.minzoom),(new com.modestmaps.Coordinate(1,1,0)).zoomTo(this.options.maxzoom)]},getTileUrl:function(a){if(!(coord=this.sourceCoordinate(a)))return null;coord.row=this.options.scheme==="tms"?Math.pow(2,coord.zoom)-coord.row-1:coord.row;return this.options.tiles[parseInt(Math.pow(2,coord.zoom)*coord.row+coord.column,10)%this.options.tiles.length].replace("{z}",coord.zoom.toFixed(0)).replace("{x}",coord.column.toFixed(0)).replace("{y}",coord.row.toFixed(0))}},com&&com.modestmaps&&com.modestmaps.extend(wax.mm.connector,com.modestmaps.MapProvider)